<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Menu & Coûts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .container { max-width: 900px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .search-results { position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">Calculateur de Coût de Revient</h2>

    <div class="card mb-4 border-primary">
        <div class="card-body">
            <h5 class="card-title">1. Charger la Base Article (Excel)</h5>
            <input type="file" id="uploadExcel" class="form-control" accept=".xlsx, .xls">
            <small class="text-muted">Le fichier doit avoir des colonnes : "Code", "Article", "Prix".</small>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label">Nom du Plat</label>
            <input type="text" id="platNom" class="form-control" placeholder="Ex: Pizza Margherita">
        </div>
        <div class="col-md-4">
            <label class="form-label">Prix de Vente TTC (€)</label>
            <input type="number" id="pvTtc" class="form-control" value="0" oninput="calculerTout()">
        </div>
        <div class="col-md-4">
            <label class="form-label">Remise (%)</label>
            <input type="number" id="remise" class="form-control" value="0" oninput="calculerTout()">
        </div>
    </div>

    <div class="mb-4 position-relative">
        <h5>2. Ajouter des Ingrédients</h5>
        <input type="text" id="searchBar" class="form-control" placeholder="Rechercher par Code ou Nom d'article..." onkeyup="rechercherArticle()">
        <ul id="resultatsRecherche" class="list-group search-results"></ul>
    </div>

    <table class="table table-bordered table-striped mt-4">
        <thead class="table-dark">
            <tr>
                <th>Code</th>
                <th>Article</th>
                <th>Prix Achat</th>
                <th>Ratio (%)</th>
                <th>Part du PV TTC (€)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
        <tfoot class="table-secondary fw-bold">
            <tr>
                <td colspan="2">Total Coût Ingrédients</td>
                <td id="totalAchat">0.00</td>
                <td>100%</td>
                <td id="totalPv">0.00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <div class="text-center mt-4">
        <button class="btn btn-success" onclick="exporterExcel()">Télécharger la Fiche (Excel)</button>
    </div>
</div>

<script>
    let baseArticles = [];
    let ingredientsPlat = [];

    // --- LOGIQUE EXCEL : LECTURE ---
    document.getElementById('uploadExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            baseArticles = XLSX.utils.sheet_to_json(firstSheet);
            alert("Base chargée : " + baseArticles.length + " articles trouvés.");
        };
        reader.readAsArrayBuffer(file);
    });

    // --- RECHERCHE AVANCÉE ---
    function rechercherArticle() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        const resultsBox = document.getElementById('resultatsRecherche');
        resultsBox.innerHTML = "";

        if (query.length < 2) return;

        const filtres = baseArticles.filter(item => 
            (item.Article && item.Article.toString().toLowerCase().includes(query)) || 
            (item.Code && item.Code.toString().toLowerCase().includes(query))
        );

        filtres.slice(0, 5).forEach(item => {
            let li = document.createElement('li');
            li.className = "list-group-item list-group-item-action";
            li.style.cursor = "pointer";
            li.innerHTML = `<strong>${item.Code}</strong> - ${item.Article} (${item.Prix}€)`;
            li.onclick = () => ajouterIngredient(item);
            resultsBox.appendChild(li);
        });
    }

    // --- GESTION DU TABLEAU ---
    function ajouterIngredient(article) {
        ingredientsPlat.push({...article});
        document.getElementById('searchBar').value = "";
        document.getElementById('resultatsRecherche').innerHTML = "";
        calculerTout();
    }

    function supprimerIngredient(index) {
        ingredientsPlat.splice(index, 1);
        calculerTout();
    }

    // --- CALCULS MATHÉMATIQUES ---
    function calculerTout() {
        const pvTtcInitial = parseFloat(document.getElementById('pvTtc').value) || 0;
        const remisePourcent = parseFloat(document.getElementById('remise').value) || 0;
        const pvTtcApresRemise = pvTtcInitial * (1 - remisePourcent / 100);

        const totalAchat = ingredientsPlat.reduce((sum, item) => sum + (parseFloat(item.Prix) || 0), 0);
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = "";

        ingredientsPlat.forEach((item, index) => {
            const prixAchat = parseFloat(item.Prix) || 0;
            const ratio = totalAchat > 0 ? (prixAchat / totalAchat) : 0;
            const partPv = pvTtcApresRemise * ratio;

            let row = `<tr>
                <td>${item.Code}</td>
                <td>${item.Article}</td>
                <td>${prixAchat.toFixed(2)}</td>
                <td>${(ratio * 100).toFixed(1)}%</td>
                <td>${partPv.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="supprimerIngredient(${index})">X</button></td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        document.getElementById('totalAchat').innerText = totalAchat.toFixed(2) + " €";
        document.getElementById('totalPv').innerText = pvTtcApresRemise.toFixed(2) + " € (après remise)";
    }

    // --- EXPORT EXCEL ---
    function exporterExcel() {
        const plat = document.getElementById('platNom').value || "Fiche_Technique";
        const data = ingredientsPlat.map(item => {
            const totalAchat = ingredientsPlat.reduce((sum, i) => sum + (parseFloat(i.Prix) || 0), 0);
            const ratio = totalAchat > 0 ? (parseFloat(item.Prix) / totalAchat) : 0;
            const pvTtc = parseFloat(document.getElementById('pvTtc').value) || 0;
            return {
                "Plat": plat,
                "Code": item.Code,
                "Article": item.Article,
                "Prix Achat": item.Prix,
                "Ratio (%)": (ratio * 100).toFixed(2),
                "Part du PV TTC": (pvTtc * ratio).toFixed(2)
            };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Calculs");
        XLSX.writeFile(wb, `${plat}_Calcul.xlsx`);
    }
</script>

</body>
</html>
